# MySQL 数据库升级指南

## 🚀 快速开始

```bash
# 运行 MySQL 升级脚本
bash upgrade-mysql.sh
```

## ✨ 脚本特点

这个脚本会**交互式引导**你完成整个升级过程：

### 自动化功能
- ✅ 自动读取配置文件
- ✅ 测试数据库连接
- ✅ 显示当前数据统计
- ✅ 自动备份数据库
- ✅ 显示待执行的迁移
- ✅ 执行升级
- ✅ 验证升级结果
- ✅ 引导配置用户组

### 交互式引导
- 📋 每一步都有清晰的说明
- ⚠️ 关键操作需要确认
- 🎨 彩色输出，易于阅读
- 📊 实时显示数据统计
- 💡 提供配置建议

## 📋 升级流程

### 步骤 1: 读取数据库配置

脚本会自动从 `configs/config.yaml` 读取配置：

```yaml
database:
  type: "mysql"
  host: "localhost"
  port: 3306
  username: "root"
  password: "your_password"
  database: "xboard"
```

如果配置不正确，可以手动输入。

### 步骤 2: 测试数据库连接

脚本会测试能否连接到数据库，如果失败会提示重新输入。

### 步骤 3: 显示当前数据

```
╔════════════════════════════════════════╗
║        当前数据库统计                  ║
╠════════════════════════════════════════╣
║  用户数:   1234 个                     ║
║  套餐数:     10 个                     ║
║  订单数:    567 个                     ║
║  节点数:      5 个                     ║
╚════════════════════════════════════════╝
```

### 步骤 4: 备份数据库

自动备份到 `backups/` 目录：

```
[INFO] 备份文件: backups/backup_before_upgrade_20231210_120000.sql
[SUCCESS] 备份完成！文件大小: 125M
```

### 步骤 5: 显示待执行的迁移

```
迁移状态:
----------------------------------------
[✓] 已执行  001_add_host_id_to_servers.sql
[✓] 已执行  002_add_user_fields.sql
[ ] 待执行  003_create_user_group.sql
[ ] 待执行  004_simplify_user_group.sql

确认执行以上迁移? [Y/n]:
```

### 步骤 6: 执行升级

执行所有待执行的迁移，保留所有现有数据。

### 步骤 7: 配置用户组

交互式配置用户组权限：

```
[INFO] 获取节点列表...
+----+----------+---------------+
| id | name     | host          |
+----+----------+---------------+
|  1 | 香港节点 | hk.example.com|
|  2 | 美国节点 | us.example.com|
|  3 | 日本节点 | jp.example.com|
+----+----------+---------------+

请输入普通用户组可访问的节点ID（逗号分隔，如: 1,2,3）: 1,2
[SUCCESS] 普通用户组节点配置完成

请输入VIP用户组可访问的节点ID（逗号分隔，如: 1,2,3,4,5）: 1,2,3
[SUCCESS] VIP用户组节点配置完成
```

## 🎯 完整示例

```bash
$ bash upgrade-mysql.sh

╔═══════════════════════════════════════════════════════════╗
║                                                           ║
║   ██╗  ██╗██████╗  ██████╗  █████╗ ██████╗ ██████╗      ║
║   ╚██╗██╔╝██╔══██╗██╔═══██╗██╔══██╗██╔══██╗██╔══██╗     ║
║    ╚███╔╝ ██████╔╝██║   ██║███████║██████╔╝██║  ██║     ║
║    ██╔██╗ ██╔══██╗██║   ██║██╔══██║██╔══██╗██║  ██║     ║
║   ██╔╝ ██╗██████╔╝╚██████╔╝██║  ██║██║  ██║██████╔╝     ║
║   ╚═╝  ╚═╝╚═════╝  ╚═════╝ ╚═╝  ╚═╝╚═╝  ╚═╝╚═════╝      ║
║                                                           ║
║           MySQL 数据库升级向导                            ║
║           安全升级 · 保留数据 · 交互引导                  ║
║                                                           ║
╚═══════════════════════════════════════════════════════════╝

[STEP] 步骤 1/7: 读取数据库配置

数据库信息:
  主机: localhost
  端口: 3306
  用户: root
  数据库: xboard

配置是否正确? [Y/n]: y

[STEP] 步骤 2/7: 测试数据库连接
[SUCCESS] 数据库连接成功

[STEP] 步骤 3/7: 获取当前数据

╔════════════════════════════════════════╗
║        当前数据库统计                  ║
╠════════════════════════════════════════╣
║  用户数:   1234 个                     ║
║  套餐数:     10 个                     ║
║  订单数:    567 个                     ║
║  节点数:      5 个                     ║
╚════════════════════════════════════════╝

按 Enter 继续...

[STEP] 步骤 4/7: 备份数据库

[INFO] 备份文件: backups/backup_before_upgrade_20231210_120000.sql
[SUCCESS] 备份完成！文件大小: 125M

按 Enter 继续...

[STEP] 步骤 5/7: 检查待执行的迁移

迁移状态:
----------------------------------------
[✓] 已执行  001_add_host_id_to_servers.sql
[✓] 已执行  002_add_user_fields.sql
[ ] 待执行  003_create_user_group.sql
[ ] 待执行  004_simplify_user_group.sql

确认执行以上迁移? [Y/n]: y

[STEP] 步骤 6/7: 执行升级

执行迁移: 003_create_user_group.sql ... 完成
执行迁移: 004_simplify_user_group.sql ... 完成
成功执行 2 个迁移

[SUCCESS] 数据库升级完成！

╔════════════════════════════════════════╗
║        升级后数据统计                  ║
╠════════════════════════════════════════╣
║  用户数:     1234 个                   ║
║  套餐数:       10 个                   ║
║  订单数:      567 个                   ║
║  用户组数:      3 个 (新增)            ║
╚════════════════════════════════════════╝

按 Enter 继续...

[STEP] 步骤 7/7: 配置用户组

是否现在配置用户组? [Y/n]: y

[INFO] 获取节点列表...
+----+----------+---------------+
| id | name     | host          |
+----+----------+---------------+
|  1 | 香港节点 | hk.example.com|
|  2 | 美国节点 | us.example.com|
|  3 | 日本节点 | jp.example.com|
+----+----------+---------------+

请输入普通用户组可访问的节点ID（逗号分隔，如: 1,2,3）: 1,2
[SUCCESS] 普通用户组节点配置完成

请输入VIP用户组可访问的节点ID（逗号分隔，如: 1,2,3,4,5）: 1,2,3
[SUCCESS] VIP用户组节点配置完成

[INFO] 获取套餐列表...
+----+----------+-------------+
| id | name     | month_price |
+----+----------+-------------+
|  1 | 基础套餐 |        1000 |
|  2 | 标准套餐 |        2000 |
|  3 | 高级套餐 |        5000 |
+----+----------+-------------+

请输入普通用户组可购买的套餐ID（逗号分隔，如: 1,2,3）: 1,2
[SUCCESS] 普通用户组套餐配置完成

请输入VIP用户组可购买的套餐ID（逗号分隔，如: 10,11,12）: 3
[SUCCESS] VIP用户组套餐配置完成

是否配置套餐的升级组? [Y/n]: y

[INFO] 配置套餐升级组...
  ID 1 = 试用用户
  ID 2 = 普通用户
  ID 3 = VIP用户

请输入要配置的套餐ID（逗号分隔）: 1,2
购买这些套餐后升级到哪个组? [2]: 2
[SUCCESS] 套餐升级组配置完成

按 Enter 查看升级结果...

╔═══════════════════════════════════════════════════════════╗
║                                                           ║
║                  ✓ 升级完成！                             ║
║                                                           ║
╚═══════════════════════════════════════════════════════════╝

备份文件位置:
  backups/backup_before_upgrade_20231210_120000.sql

数据对比:

升级前:
用户数: 1234
套餐数: 10
订单数: 567

升级后:
用户数: 1234
套餐数: 10
订单数: 567
用户组数: 3

下一步操作:
  1. 重启服务: docker compose restart
  2. 查看日志: docker compose logs -f
  3. 测试功能: 访问后台管理

如果遇到问题，可以使用备份恢复:
  mysql -hlocalhost -P3306 -uroot -p xboard < backups/backup_before_upgrade_20231210_120000.sql

详细文档:
  用户组设计: docs/user-group-design.md
  升级指南:   docs/upgrade-guide.md
```

## ⚠️ 注意事项

1. **确保有 MySQL 客户端**
   ```bash
   # 检查
   mysql --version
   
   # 安装
   # Ubuntu/Debian
   sudo apt-get install mysql-client
   
   # CentOS/RHEL
   sudo yum install mysql
   ```

2. **确保数据库可访问**
   - 检查防火墙设置
   - 检查 MySQL 用户权限
   - 检查网络连接

3. **备份很重要**
   - 脚本会自动备份
   - 也可以手动备份
   - 保留备份至少 7 天

4. **升级期间停止服务**
   ```bash
   docker compose down
   # 或
   systemctl stop xboard
   ```

## 🔙 回滚方案

如果升级出现问题：

```bash
# 使用脚本创建的备份恢复
mysql -hlocalhost -P3306 -uroot -p xboard < backups/backup_before_upgrade_20231210_120000.sql

# 或使用你自己的备份
mysql -hlocalhost -P3306 -uroot -p xboard < your_backup.sql
```

## 📚 相关文档

- [完整升级指南](docs/upgrade-guide.md)
- [用户组设计](docs/user-group-design.md)
- [数据库迁移](docs/database-migration.md)

## 🆘 常见问题

### Q: 脚本卡住不动？

A: 可能是在等待输入密码，检查终端提示。

### Q: 连接数据库失败？

A: 检查配置文件中的数据库信息是否正确。

### Q: 备份失败？

A: 确保有足够的磁盘空间，检查 MySQL 用户权限。

### Q: 可以跳过配置用户组吗？

A: 可以，稍后可以手动配置：

```sql
mysql -hlocalhost -P3306 -uroot -p xboard

UPDATE v2_user_group SET server_ids = '[1,2,3]' WHERE id = 2;
UPDATE v2_user_group SET plan_ids = '[1,2,3]' WHERE id = 2;
UPDATE v2_plan SET upgrade_group_id = 2 WHERE id = 1;
```

## 🎉 升级完成后

1. **重启服务**
   ```bash
   docker compose restart
   ```

2. **测试功能**
   - 登录后台
   - 查看用户组管理
   - 测试套餐购买

3. **查看日志**
   ```bash
   docker compose logs -f
   ```

祝升级顺利！🚀
